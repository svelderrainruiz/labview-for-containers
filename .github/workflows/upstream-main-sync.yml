name: Upstream Main Sync

on:
  workflow_dispatch:
  schedule:
    - cron: "17 5 * * *"

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: upstream-main-sync
  cancel-in-progress: false

jobs:
  sync-upstream-main:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: Checkout main
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Evaluate and execute sync
        id: sync
        env:
          GH_TOKEN: ${{ github.token }}
        shell: bash
        run: |
          set -euo pipefail
          git remote add upstream https://github.com/ni/labview-for-containers.git || true
          git fetch origin main --prune
          git fetch upstream main --prune

          main_sha="$(git rev-parse origin/main)"
          upstream_sha="$(git rev-parse upstream/main)"

          echo "main_sha=$main_sha" >> "$GITHUB_OUTPUT"
          echo "upstream_sha=$upstream_sha" >> "$GITHUB_OUTPUT"

          if [[ "$main_sha" == "$upstream_sha" ]]; then
            echo "outcome=in_sync" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          if git merge-base --is-ancestor "$main_sha" "$upstream_sha"; then
            git checkout -B main origin/main
            git merge --ff-only upstream/main
            if git push origin HEAD:main; then
              echo "outcome=fast_forwarded" >> "$GITHUB_OUTPUT"
              exit 0
            fi

            # Reset local branch before opening a sync PR path.
            git reset --hard origin/main
            git clean -fd
          fi

          sync_branch="sync/upstream-$(date -u +%Y%m%d-%H%M%S)"
          git checkout -B "$sync_branch" upstream/main
          git push origin "$sync_branch" --force

          existing_pr="$(gh pr list \
            --repo "${{ github.repository }}" \
            --head "$sync_branch" \
            --base main \
            --state open \
            --json number \
            --jq '.[0].number')"

          if [[ -z "${existing_pr:-}" || "${existing_pr}" == "null" ]]; then
            gh pr create \
              --repo "${{ github.repository }}" \
              --base main \
              --head "$sync_branch" \
              --title "Sync upstream main (${upstream_sha:0:7})" \
              --body "Automated upstream sync proposal.\n\n- upstream/main: \`${upstream_sha}\`\n- org/main before sync: \`${main_sha}\`\n- outcome: \`conflict_requires_pr\`\n\nThis PR was created by the upstream sync workflow."
          fi

          echo "outcome=conflict_requires_pr" >> "$GITHUB_OUTPUT"
          echo "sync_branch=$sync_branch" >> "$GITHUB_OUTPUT"

      - name: Write summary
        if: always()
        run: |
          {
            echo "### Upstream Main Sync"
            echo ""
            echo "- Outcome: \`${{ steps.sync.outputs.outcome }}\`"
            echo "- org/main: \`${{ steps.sync.outputs.main_sha }}\`"
            echo "- upstream/main: \`${{ steps.sync.outputs.upstream_sha }}\`"
            if [[ -n "${{ steps.sync.outputs.sync_branch }}" ]]; then
              echo "- Sync branch: \`${{ steps.sync.outputs.sync_branch }}\`"
            fi
          } >> "$GITHUB_STEP_SUMMARY"
